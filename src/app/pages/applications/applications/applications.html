<mat-card class="card">
  <div class="header">
    <div>
      <div class="title">Applications</div>
      <div class="subtitle">Filter, review, shortlist and update application pipeline</div>
    </div>
  </div>

  <mat-tab-group (selectedIndexChange)="onTabChange($event)">
    <mat-tab label="All Applications">
      <div class="tab-pad">
        <ng-container *ngTemplateOutlet="filters"></ng-container>
        <ng-container *ngTemplateOutlet="table"></ng-container>
      </div>
    </mat-tab>

    <mat-tab label="By Job Pipeline">
      <div class="tab-pad">
        <div class="job-picker">
          <mat-form-field appearance="outline" class="jobField">
            <mat-label>Select Job</mat-label>
            <mat-select [value]="selectedJobId()" (selectionChange)="selectedJobId.set($event.value); page.set(1); runSearch();">
              <mat-option *ngFor="let j of jobs()" [value]="j.id">
                {{ j.title }} • {{ j.department }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="job-title" *ngIf="activeJobTitle()">
            <mat-icon>work</mat-icon>
            <span>{{ activeJobTitle() }}</span>
          </div>
        </div>

        <ng-container *ngIf="selectedJobId(); else pickJob">
          <ng-container *ngTemplateOutlet="filters"></ng-container>
          <ng-container *ngTemplateOutlet="table"></ng-container>
        </ng-container>

        <ng-template #pickJob>
          <div class="empty">
            Select a job to view its pipeline.
          </div>
        </ng-template>
      </div>
    </mat-tab>
  </mat-tab-group>
</mat-card>

<!-- Filters template -->
<ng-template #filters>
  <div class="filters" [formGroup]="filterForm">
    <mat-form-field appearance="outline" class="w200">
      <mat-label>Status</mat-label>
      <mat-select formControlName="status" multiple>
        <mat-option *ngFor="let s of statuses" [value]="s">{{ s }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w240">
      <mat-label>Keyword</mat-label>
      <input matInput formControlName="keyword" placeholder="name, email, phone, job..." />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w160">
      <mat-label>Min Salary</mat-label>
      <input matInput type="number" formControlName="minSalary" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="w160">
      <mat-label>Max Salary</mat-label>
      <input matInput type="number" formControlName="maxSalary" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="w180">
      <mat-label>Min Exp (yrs)</mat-label>
      <input matInput type="number" formControlName="minExperienceYears" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="w180">
      <mat-label>Max Exp (yrs)</mat-label>
      <input matInput type="number" formControlName="maxExperienceYears" />
    </mat-form-field>

    <mat-form-field appearance="outline" class="w160">
      <mat-label>Sort By</mat-label>
      <mat-select formControlName="sortBy">
        <mat-option *ngFor="let o of sortByOptions" [value]="o.value">{{ o.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="w140">
      <mat-label>Order</mat-label>
      <mat-select formControlName="sortOrder">
        <mat-option value="desc">Desc</mat-option>
        <mat-option value="asc">Asc</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="filter-actions">
      <button mat-flat-button color="primary" (click)="page.set(1); runSearch()">
        <mat-icon>filter_alt</mat-icon>
        Apply
      </button>
      <button mat-button (click)="resetFilters()">Reset</button>
    </div>
  </div>
</ng-template>

<!-- Table template -->
<ng-template #table>
  <div class="table-wrap" *ngIf="!loading(); else busy">
    <table mat-table [dataSource]="items()" class="table">

      <ng-container matColumnDef="candidate">
        <th mat-header-cell *matHeaderCellDef> Candidate </th>
        <td mat-cell *matCellDef="let r">
          <div class="cell-main">{{ r.candidateName || r.fullName || '—' }}</div>
          <div class="cell-sub">{{ r.candidateEmail || r.email || '' }} • {{ r.candidatePhone || r.phone || '' }}</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="job">
        <th mat-header-cell *matHeaderCellDef> Job </th>
        <td mat-cell *matCellDef="let r">
          <div class="cell-main">{{ r.jobTitle || '—' }}</div>
          <div class="cell-sub">{{ r.department || '' }}</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let r">
          <mat-chip class="chip" [ngClass]="statusClass(r.status)">
            {{ r.status }}
          </mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="salary">
        <th mat-header-cell *matHeaderCellDef> Salary </th>
        <td mat-cell *matCellDef="let r">
          <span *ngIf="r.expectedSalary !== null && r.expectedSalary !== undefined">
            {{ r.expectedSalary }} {{ r.salaryCurrency || '' }}
          </span>
          <span *ngIf="r.expectedSalary === null || r.expectedSalary === undefined">—</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="experience">
        <th mat-header-cell *matHeaderCellDef> Experience </th>
        <td mat-cell *matCellDef="let r">
          {{ r.experienceYears ?? '—' }} yrs
        </td>
      </ng-container>

      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef> Created </th>
        <td mat-cell *matCellDef="let r">
          {{ (r.createdAt || r.createdOn) | date:'medium' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="actions-col"> Actions </th>
        <td mat-cell *matCellDef="let r" class="actions-col">
          <button mat-icon-button (click)="changeStatus(r)" matTooltip="Change status">
            <mat-icon>sync</mat-icon>
          </button>

          <button mat-icon-button (click)="openHistory(r)" matTooltip="History">
            <mat-icon>history</mat-icon>
          </button>

          <button mat-icon-button [disabled]="!(r.resumeUrlSnapshot || r.resumeUrl)" (click)="openResume(r)" matTooltip="Open CV">
            <mat-icon>description</mat-icon>
          </button>
          <button mat-icon-button (click)="openDetails(r)" matTooltip="View details">
  <mat-icon>visibility</mat-icon>
</button>

        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator
      [length]="total()"
      [pageIndex]="page() - 1"
      [pageSize]="pageSize()"
      [pageSizeOptions]="[10, 20, 50, 100]"
      (page)="onPage($event)">
    </mat-paginator>

    <div class="empty" *ngIf="items().length === 0">
      No applications found.
    </div>
  </div>

  <ng-template #busy>
    <div class="busy">
      <mat-spinner diameter="32"></mat-spinner>
      <div>Loading applications...</div>
    </div>
  </ng-template>
</ng-template>
